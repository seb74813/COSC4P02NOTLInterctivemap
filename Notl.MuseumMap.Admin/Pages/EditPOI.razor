@inherits BasePage
@attribute [Authorize]
<BusyIndicator Model="@this" />

@if (!IsBusy && Poi != null)
{
	<MudContainer MaxWidth="MaxWidth.Large">
		<EditForm Model="Poi" OnValidSubmit="ReturnToMap">
			<MudCard>
				<MudCardHeader>
					<MudText Typo="Typo.h4">
						New POI
					</MudText>
				</MudCardHeader>
				<MudCardContent>
					<MudStack>
						<MudPaper>
							@if (Poi.Image != null)
							{
								<MudImage Src="@Poi.Image.Url" Fluid=true />
							}
							<MudButton HtmlTag="label"
								   Variant="Variant.Filled"
								   Color="Color.Primary"
								   StartIcon="@Icons.Material.Filled.CloudUpload"
								   for="upload">
								Upload Image
							</MudButton>

							<InputFile id="upload" accept="image/*" OnChange="UploadPhotoAsync" class="d-none" />
						</MudPaper>

						<MudTextField @bind-Value=Poi.Title Label="POI Title"/>
						
							<MudRadioGroup @bind-SelectedOption=Poi.PoiType>
								<MudRadio Option="POIType.Exhibit">Exhibit</MudRadio>
								<MudRadio Option="POIType.Item">Item</MudRadio>
								<MudRadio Option="POIType.Bathroom">Bathroom</MudRadio>
								<MudRadio Option="POIType.Accessability">Accessibility</MudRadio>
							</MudRadioGroup>
						<MarkdownEditor @bind-Value="Poi.Description"/>
					</MudStack>
				</MudCardContent>
				<MudCardActions>
					<MudButton ButtonType="ButtonType.Submit" Color="Color.Primary" Class="ml-auto mr-6 mb-3">
						Close
					</MudButton>
				</MudCardActions>
			</MudCard>
		</EditForm>
	</MudContainer>
}

@code {
	[Parameter]
	public POIModel? Poi { get; set; }
	[Parameter]
	public EventCallback OnExit { get; set; }

	protected async override Task OnInitializedAsync()
	{
		await base.OnInitializedAsync();
		IsInitialized = true;
		IsBusy = false;

	}
	
	Task OnMarkdownValueChanged(string value)
	{

		return Task.CompletedTask;
	}
	public async Task UploadPhotoAsync(InputFileChangeEventArgs e)
	{
		try
		{
			if (Poi == null)
			{
				throw new Exception();
			}

			var file = e.File;

			var stream = file.OpenReadStream();

			IsBusy = true;
			var image = await ClientContext.Admin.UpdatePOIImageAsync(Poi.Id, new FileParameter(stream));
			Poi.Image = image;
			IsBusy = false;
		}
		catch (Exception ex)
		{
			ShowError(ex);
		}
	}
	private async Task ReturnToMap()
	{
		await OnExit.InvokeAsync();
	}

}


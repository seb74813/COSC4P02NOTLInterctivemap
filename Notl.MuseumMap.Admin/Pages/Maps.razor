@page "/"
@inherits BasePage
@attribute [Authorize]

<BusyIndicator Model="@this" />
<PageTitle>@Localizer["AppName"]</PageTitle>

@if (!IsBusy && maps!=null && activeMap!=null)
{
    <MudGrid>
        <MapView Data="activeMap" OnClick="SelectMap" OnDelete="DeleteMap" IsActive=true />

     
        @foreach (var map in maps)
        {
            if (map.Id != activeMap.Id)
            {
                <MapView Data="map" OnClick="SelectMap" OnDelete="DeleteMap" OnActive="SetActiveMap" IsActive=false />
            }
           
        }
    </MudGrid>
}

@code
{
    private List<MapModel>? maps;
    private MapModel? activeMap;


    protected async override Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        IsInitialized = true;

        try
        {
            IsBusy = true;
            await Refresh();

            IsBusy = false;
        }
        catch (Exception ex)
        {
            ShowError(ex);
        }
    }
    private async Task Refresh()
    {   
        maps = await ClientContext.Admin.GetMapsAsync();
        if (maps == null || maps.Count == 0)
        {
            activeMap = await ClientContext.Admin.CreateMapAsync();
            
        }
        else
        {
            activeMap = await ClientContext.Admin.GetActiveMapAuthAsync();
           
        }
        if (activeMap.Image == null)
        {
            NavigateUploadImage(activeMap);
        }
    }

    private async Task DeleteMap(MapModel map)
    {

        var parameters = new DialogParameters();
        parameters.Add("ContentText", "Do you really want to delete this Map? This process cannot be undone.");
        parameters.Add("ButtonText", "Delete");
        parameters.Add("Color", Color.Error);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Small };

        var dialog = Dialog.Show<DeleteDialog>("Delete", parameters, options);

        var result = await dialog.Result;

        try
        {
            IsBusy = true;

           

            if (!result.Canceled)
            {
                await ClientContext.Admin.DeleteMapAsync(map.Id);
                await Refresh();
                
            }

            IsBusy = false;

        }
        catch (Exception ex)
        {
            ShowError(ex);
        }
    }

    private async Task SetActiveMap(MapModel map)

    {
        try
        {
            IsBusy = true;
            await ClientContext.Admin.UpdateActiveMapAsync(map.Id);
            await Refresh();
            IsBusy = false;
        }
        catch (Exception ex)
        {
            ShowError(ex);
        }
    }

    private void SelectMap(MapModel model)
    {
        Navigation.NavigateTo($"map/{model.Id}");
    }

    private void NavigateUploadImage(MapModel model)
    {
        Navigation.NavigateTo($"map/{model.Id}");
    }
}